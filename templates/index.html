<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDP PDF Validator</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Branding */
        :root { --amazon-orange:#FF9900; --amazon-dark:#232F3E; --amazon-font:'Amazon Ember',Arial,sans-serif; }
        body { background:#f2f3f5; font-family:var(--amazon-font); padding:2rem; }
        .main-container { max-width:800px; margin:auto; background:#fff; padding:2rem; border:1px solid #e0e0e0; border-radius:4px; }
        .header { background:var(--amazon-dark); color:#fff; padding:1rem; border-radius:4px; display:flex; align-items:center; margin-bottom:1.5rem; }
        .header img { height:40px; margin-right:1rem; }
        .header h1 { margin:0; color:var(--amazon-orange); font-size:1.75rem; }
        .dropzone { border:2px dashed #ccc; border-radius:4px; padding:2rem; text-align:center; background:#fafafa; cursor:pointer; }
        .dropzone:hover { background:#f0f0f0; }
        .dropzone-hover { border-color:var(--amazon-dark); background:#ddd; }
        .analysis-card { background:#fff; border:1px solid #ddd; border-radius:4px; padding:1.5rem; margin-bottom:1.5rem; }
        .analysis-header { display:flex; align-items:center; font-size:1.25rem; margin-bottom:1rem; }
        .analysis-header i { margin-right:0.5rem; }
        /* Amazon Orange button style */
        .btn-amazon {
            background-color: var(--amazon-orange) !important;
            border-color: var(--amazon-orange) !important;
            color: #fff !important;
        }
        .btn-amazon:hover {
            background-color: #e68a00 !important; /* Slightly darker on hover */
            border-color: #e68a00 !important;
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <!-- KDP Header -->
        <div class="header bg-amazon-dark d-flex align-items-center mb-4" style="padding:1rem;border-radius:4px;">
            <img src="{{ url_for('static', filename='kdp-logo.png') }}" alt="KDP Logo" style="height:60px;margin-right:1rem;">
            <div>
                <h1 class="text-orange m-0">KDP PDF Validator</h1>
                <p class="lead m-0" style="color:#eaeaea;">Check if your PDF meets KDP's print guidelines</p>
            </div>
        </div>
        <!-- Upload Form -->
        <form id="pdfUploadForm" action="/upload" method="post" enctype="multipart/form-data">
            <div class="analysis-card upload-card">
                <h3 class="analysis-header"><i class="bi bi-file-earmark-pdf-fill"></i> Upload and Validate PDF</h3>
                <div class="dropzone" onclick="document.getElementById('pdfFile').click()">
                    <p>Drag &amp; drop your PDF here</p>
                    <p>or click to select a file</p>
                </div>
                <input type="file" id="pdfFile" name="file" accept="application/pdf" class="d-none" required>

                <div class="mb-3">
                    <label for="validationMode" class="form-label">Validation Type</label>
                    <select class="form-select" id="validationMode" name="validation_mode">
                        <option value="interior" selected>Interior Manuscript</option>
                        <option value="cover">Cover (Back+Spine+Front)</option>
                    </select>
                </div>

                <div class="mb-3 mt-3">
                    <label for="bookType" class="form-label">Book Type</label>
                    <select class="form-select" id="bookType" name="book_type">
                        <option value="paperback" selected>Paperback</option>
                        <option value="hardcover">Hardcover</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="trimSize" class="form-label">Trim Size</label>
                    <select class="form-select" id="trimSize" name="trim_size" required>
                        <option value="" disabled selected>Choose trim size...</option>
                    </select>
                </div>

                <!-- Custom dimensions inputs (hidden by default) -->
                <div class="mb-3" id="customTrimInputs" style="display:none;">
                    <div class="row g-2">
                        <div class="col">
                            <input type="number" step="0.01" class="form-control" id="customWidth" name="custom_width" placeholder="Width (inches)" min="4" max="8.5">
                        </div>
                        <div class="col">
                            <input type="number" step="0.01" class="form-control" id="customHeight" name="custom_height" placeholder="Height (inches)" min="6" max="11.69">
                        </div>
                    </div>
                    <div class="form-text">Width 4"–8.5", Height 6"–11.69"</div>
                </div>

                <div class="mb-3">
                    <label for="colorOption" class="form-label">Color Option</label>
                    <select class="form-select" id="colorOption" name="color_option" required>
                        {% for code, name in color_options.items() %}
                        <option value="{{ code }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="bleedCheck" name="include_bleed" value="true">
                    <label class="form-check-label" for="bleedCheck">Does it include Bleed?</label>
                </div>

                <div id="coverPageCountGroup" class="mb-3 d-none">
                    <label for="pageCount" class="form-label">Interior Page Count</label>
                    <input type="number" class="form-control" id="pageCount" name="page_count" min="1" placeholder="Total interior pages">
                    <div class="form-text">Needed to calculate spine thickness for cover</div>
                </div>

                <button type="submit" class="btn btn-amazon w-100 mt-3">Check PDF</button>
                <div id="progressContainer" class="mt-3 d-none">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">0%</div>
                    </div>
                    <div id="processingMsg" class="mt-2 small text-info">Uploading...</div>
                </div>
            </div>
        </form>

        <!-- Footer -->
        <div class="text-center text-muted mt-3">
            <small>This tool checks your PDF against KDP's print guidelines. <a href="https://kdp.amazon.com/en_US/help/topic/G201834180" target="_blank">KDP Help Center</a></small>
        </div>
    </div>

    <!-- Hidden size data for JS -->
    <div id="sizeData" data-pb='{{ paperback_trim_sizes|tojson }}' data-hc='{{ hardcover_trim_sizes|tojson }}' style="display:none;"></div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Book Type selection handlers -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Grab custom trim inputs
        const customTrimDiv = document.getElementById('customTrimInputs');
        const customWidthInput = document.getElementById('customWidth');
        const customHeightInput = document.getElementById('customHeight');
        // KDP trim sizes passed from server via hidden element
        const sizeDataEl = document.getElementById('sizeData');
        const pbSizes = JSON.parse(sizeDataEl.getAttribute('data-pb'));
        const hcSizes = JSON.parse(sizeDataEl.getAttribute('data-hc'));
        const bookTypeSelect = document.getElementById('bookType');
        const trimSizeSelect = document.getElementById('trimSize');
        const colorOptionSelect = document.getElementById('colorOption');
        const dropzone = document.querySelector('.dropzone');
        const pdfFileInput = document.getElementById('pdfFile');

        function populateTrimSizes(sizes) {
            trimSizeSelect.innerHTML = '<option value="" disabled selected>Choose trim size...</option>';
            sizes.forEach(size => {
                const opt = document.createElement('option');
                opt.value = size;
                opt.textContent = `${size} inches`;
                trimSizeSelect.appendChild(opt);
            });
        }

        function handleBookTypeChange() {
            const type = bookTypeSelect.value;
            // Populate trim sizes based on book type
            populateTrimSizes(type === 'paperback' ? pbSizes : hcSizes);
            // Remove any existing custom option
            const existingCustom = trimSizeSelect.querySelector('option[value="custom"]');
            if (existingCustom) existingCustom.remove();
            // Add custom trim option only for paperback
            if (type === 'paperback') {
                const customOpt = document.createElement('option');
                customOpt.value = 'custom';
                customOpt.textContent = 'Custom trim size';
                trimSizeSelect.appendChild(customOpt);
            }
            const stdOpt = colorOptionSelect.querySelector('option[value="standard_color"]');
            if (stdOpt) {
                stdOpt.hidden = type === 'hardcover';
                stdOpt.disabled = type === 'hardcover';
                if (type === 'hardcover' && colorOptionSelect.value === 'standard_color') {
                    colorOptionSelect.selectedIndex = 0;
                }
            }
            // Reset custom inputs
            customTrimDiv.style.display = 'none';
            customWidthInput.required = false;
            customHeightInput.required = false;
        }

        // Update trim sizes only on book type change
        bookTypeSelect.addEventListener('change', handleBookTypeChange);
        handleBookTypeChange();

        // Show/hide custom inputs when trim size changes
        trimSizeSelect.addEventListener('change', () => {
            if (trimSizeSelect.value === 'custom') {
                customTrimDiv.style.display = 'block';
                customWidthInput.required = true;
                customHeightInput.required = true;
            } else {
                customTrimDiv.style.display = 'none';
                customWidthInput.required = false;
                customHeightInput.required = false;
            }
        });

        ['dragenter', 'dragover'].forEach(evt =>
            dropzone.addEventListener(evt, e => {
                e.preventDefault(); e.stopPropagation();
                dropzone.classList.add('dropzone-hover');
            })
        );
        // Handle file drop
        dropzone.addEventListener('dragleave', e => {
            e.preventDefault(); e.stopPropagation();
            dropzone.classList.remove('dropzone-hover');
        });
        dropzone.addEventListener('drop', e => {
            e.preventDefault(); e.stopPropagation();
            dropzone.classList.remove('dropzone-hover');
            if (e.dataTransfer.files.length) {
                // Use DataTransfer to set the file input
                const dt = new DataTransfer();
                for (const file of e.dataTransfer.files) {
                    dt.items.add(file);
                }
                pdfFileInput.files = dt.files;
                // Show the file name in the drop zone
                dropzone.innerHTML = `<p>${dt.files[0].name}</p>`;
            }
        });
        // Display selected file name when using file picker
        pdfFileInput.addEventListener('change', () => {
            if (pdfFileInput.files.length) {
                dropzone.innerHTML = `<p>${pdfFileInput.files[0].name}</p>`;
            }
        });
        // Cover vs Interior UI toggle
        const validationModeSelect = document.getElementById('validationMode');
        const coverPageCountGroup = document.getElementById('coverPageCountGroup');
        function handleValidationModeChange() {
            if (validationModeSelect.value === 'cover') {
                bookTypeSelect.closest('.mb-3').style.display = '';
                trimSizeSelect.closest('.mb-3').style.display = '';
                customTrimDiv.style.display = 'none';
                colorOptionSelect.closest('.mb-3').style.display = '';
                // Bleed is mandatory for cover: hide the question and check it
                const bleedEl = document.getElementById('bleedCheck');
                bleedEl.closest('.form-check').style.display = 'none';
                bleedEl.checked = true;
                coverPageCountGroup.classList.remove('d-none');
                document.getElementById('pageCount').required = true;
            } else {
                bookTypeSelect.closest('.mb-3').style.display = '';
                trimSizeSelect.closest('.mb-3').style.display = '';
                colorOptionSelect.closest('.mb-3').style.display = '';
                customTrimDiv.style.display = 'none';
                coverPageCountGroup.classList.add('d-none');
                document.getElementById('pageCount').required = false;
                // Restore bleed checkbox visibility for interior
                const bleedEl = document.getElementById('bleedCheck');
                bleedEl.closest('.form-check').style.display = '';
                bleedEl.checked = false;
            }
            // Re-populate trim & color options based on bookType for cover mode
            handleBookTypeChange();
        }
        validationModeSelect.addEventListener('change', handleValidationModeChange);
        handleValidationModeChange();
        // Add AJAX upload with progress
        const form = document.getElementById('pdfUploadForm');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const processingMsg = document.getElementById('processingMsg');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            progressContainer.classList.remove('d-none');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            const formData = new FormData(form);
            const xhr = new XMLHttpRequest();
            xhr.open('POST', form.action, true);
            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                }
            };
            xhr.upload.onload = function() {
                progressBar.style.width = '100%';
                progressBar.textContent = 'Upload complete, processing...';
                progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                processingMsg.textContent = 'Processing PDF, please wait...';
            };
            xhr.onload = function() {
                document.open(); document.write(xhr.responseText); document.close();
            };
            xhr.onerror = function() {
                processingMsg.textContent = 'An error occurred. Please try again.';
            };
            xhr.send(formData);
        });
    });
    </script>
</body>
</html> 